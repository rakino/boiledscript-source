---
title: "ESP 被霸占的解决方案"
date: 2019-08-27T08:00:00+08:00
---

两天前，我在新机上以 GPT + EFI 的方式装好了 Arch Linux。

这天晚上，我开始安装 Deepin，然而它的安装器并未提供“不安装启动引导器”的选项，因而 ESP 被无情地霸占了…

接下来该怎么做呢？重装 Arch Linux？显然不是。

## 什么是 ESP？
这点显然不是我能简单解释的（我自己也是一知半解）。

以下摘自 [Arch Linux Wiki](https://wiki.archlinux.org/index.php/EFI_system_partition_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))： > [EFI 系统分区](https://en.wikipedia.org/wiki/EFI_System_partition)(也称为 ESP 或者 EFISYS)是一个 FAT32 格式的物理分区 (在硬盘主分区表上，而不是 LVM 或软件 RAID 等等) ，从这里 [UEFI](https://wiki.archlinux.org/index.php/UEFI) 固件启动 UEFI 引导器和应用程序。 > > 它与操作系统无关而是作为 EFI 固件要启动的引导器和应用程序的存储空间，是 UEFI 启动所必须。 > > 推荐使用 GPT 和 UEFI 搭配因为有的 UEFI 固件不支持 UEFI-MBR 启动。

因为 EFI 支持的文件系统较少，大概都是 Fat32 这类的非日志式文件系统，且单文件大小限制已经不能满足现在的需求了，显然**一般**不会有人拿它作为日常文件系统，这时候倒不如专门分一个区。而被格式化为 Fat32 文件系统的 EFI 类型分区亦被称为 “ESP”。

## 被霸占了？
像 Grub 这样的引导加载器，是可以安装在 ESP 里边的，像系统内核、微码更新之类的东西也都放在里边；Deepin 的安装器没有把安装引导加载器的自主权交给用户（也许有面向群体的因素），把 ESP 给覆写了，现在没有 Arch Linux 的内核文件了，自然也就无法启动 Arch Linux 了。

## 怎样做？
*这里我会把 Grub 的控制权交给 Deepin（在它上面设置 Grub 还是挺方便的），并取消 Arch Linux 上对 ESP 的默认挂载，与此同时， Arch Linux 上的 `/boot` 变成了空文件夹，因而需要重新在其中放置内核和微码更新补丁镜像（此时重新安装是一个相对而言更方便的选择，我也不知道其它选择是什么。）*

首先需要进入到 Archiso（Arch Linux 的安装镜像），挂载好 Arch Linux 的根分区（不挂载 ESP，确保能访问到 Arch Linux 的 `/etc` 以及执行命令就好了）

其次需要修改 Arch Linux 上的 `/etc/fstab`，删除与 ESP 有关的行。

重新安装内核以及微码更新补丁（现在已经不再需要 Grub 了）

``` shell
#（可选）我先卸载掉原先的内核，如果还想继续使用原先的内核则不必
pacman -Rscn linux

#这里我使用 linux-lts（long-term support，长期支持）内核，若想使用默认的 linux 内核，将 linux-lts 修改为 linux 即可
#我的 CPU 是 AMD 的，因而需要安装 amd-ucode（AMD 的微码更新补丁），若是 Intel 的 CPU 则安装 intel-ucode
pacman -S linux-lts amd-ucode
```

然后可以离开 Archiso 进入 Deepin 了

在 Deepin 中执行

``` shell
sudo update-grub2
```

结束。
